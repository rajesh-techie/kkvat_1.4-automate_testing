<div class="scheduler-container">
  <div class="scheduler-header">
    <h2>Report Scheduler</h2>
    <button class="btn btn-primary" (click)="openForm()" *ngIf="!showForm">
      + New Schedule
    </button>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="error" class="alert alert-danger">
    <strong>Error:</strong> {{ error }}
  </div>
  <div *ngIf="success" class="alert alert-success">
    <strong>Success:</strong> {{ success }}
  </div>

  <!-- Schedule Form -->
  <div *ngIf="showForm" class="schedule-form-container">
    <div class="form-header">
      <h3>{{ editingId ? 'Edit Schedule' : 'Create New Schedule' }}</h3>
      <button class="btn btn-close" (click)="cancelForm()">✕</button>
    </div>

    <form [formGroup]="scheduleForm" class="schedule-form">
      
      <div class="form-group">
        <label for="reportId">Select Report *</label>
        <select id="reportId" class="form-control" formControlName="reportId">
          <option value="">-- Choose a report --</option>
          <option *ngFor="let report of reports" [value]="report.id">
            {{ report.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="scheduleName">Schedule Name *</label>
        <input 
          type="text" 
          id="scheduleName" 
          class="form-control" 
          formControlName="scheduleName"
          placeholder="e.g., Daily Executive Report">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="frequency">Frequency *</label>
          <select 
            id="frequency" 
            class="form-control" 
            formControlName="frequency"
            (change)="onFrequencyChange($any($event.target).value)">
            <option *ngFor="let freq of frequencies" [value]="freq">
              {{ getFrequencyDisplay(freq) }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="scheduleForm.get('frequency')?.value === 'WEEKLY'">
          <label for="dayOfWeek">Day of Week *</label>
          <select id="dayOfWeek" class="form-control" formControlName="dayOfWeek">
            <option *ngFor="let day of daysOfWeek" [value]="day.value">
              {{ day.label }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="['MONTHLY', 'QUARTERLY', 'ANNUALLY'].includes(scheduleForm.get('frequency')?.value)">
          <label for="dayOfMonth">Day of Month *</label>
          <input 
            type="number" 
            id="dayOfMonth" 
            class="form-control" 
            formControlName="dayOfMonth"
            min="1" 
            max="31"
            placeholder="1-31">
        </div>

        <div class="form-group">
          <label for="timeOfDay">Time of Day *</label>
          <input 
            type="time" 
            id="timeOfDay" 
            class="form-control" 
            formControlName="timeOfDay">
        </div>
      </div>

      <div class="form-group">
        <label for="emailRecipients">Email Recipients (optional)</label>
        <input 
          type="text" 
          id="emailRecipients" 
          class="form-control" 
          formControlName="emailRecipients"
          placeholder="email1@example.com, email2@example.com">
        <small class="form-text">Comma-separated email addresses to receive the report</small>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="isActive">
          Active (schedule will execute)
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancelForm()">
          Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="saveSchedule()" [disabled]="saving">
          {{ saving ? 'Saving...' : 'Save Schedule' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Schedules List -->
  <div class="schedules-list" *ngIf="!showForm">
    <div *ngIf="loading" class="loading">Loading schedules...</div>

    <div *ngIf="!loading && schedules.length === 0" class="no-data">
      <p>No schedules found. Create one to get started!</p>
    </div>

    <div *ngIf="!loading && schedules.length > 0" class="schedules-table">
      <table class="table">
        <thead>
          <tr>
            <th>Schedule Name</th>
            <th>Report</th>
            <th>Frequency</th>
            <th>Time</th>
            <th>Email Recipients</th>
            <th>Status</th>
            <th>Next Execution</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let schedule of schedules" [class.inactive]="!schedule.isActive">
            <td>{{ schedule.scheduleName }}</td>
            <td>{{ getReportName(schedule.reportId) }}</td>
            <td>
              <span class="badge" [ngClass]="{'badge-primary': schedule.isActive, 'badge-secondary': !schedule.isActive}">
                {{ getFrequencyDisplay(schedule.frequency) }}
              </span>
            </td>
            <td>{{ schedule.timeOfDay }}</td>
            <td>{{ schedule.emailRecipients || '-' }}</td>
            <td>
              <span *ngIf="schedule.isActive" class="badge badge-success">Active</span>
              <span *ngIf="!schedule.isActive" class="badge badge-danger">Inactive</span>
            </td>
            <td>{{ formatNextExecution(schedule.nextExecution) }}</td>
            <td>
              <button class="btn btn-sm btn-info" (click)="editSchedule(schedule)">
                Edit
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteSchedule(schedule.id)">
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && schedules.length > 0" class="pagination-controls">
      <button 
        class="btn btn-secondary btn-sm" 
        (click)="previousPage()" 
        [disabled]="!hasPreviousPage">
        ← Previous
      </button>

      <span class="pagination-info">
        Page {{ currentPage + 1 }} of {{ Math.ceil(totalSchedules / pageSize) }}
        ({{ totalSchedules }} total)
      </span>

      <button 
        class="btn btn-secondary btn-sm" 
        (click)="nextPage()" 
        [disabled]="!hasNextPage">
        Next →
      </button>
    </div>
  </div>
</div>
